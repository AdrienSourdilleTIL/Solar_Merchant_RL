# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

**Python 3.10+** | **Dependencies**: gymnasium, stable-baselines3, pandas, numpy, torch

This project trains a **Reinforcement Learning agent** to operate a **utility-scale solar farm with battery storage** trading on the **day-ahead electricity market**.

The agent learns to:
1. Commit hourly energy delivery for the next day (at 11:00 each day)
2. Manage battery charge/discharge to meet commitments
3. Balance revenue maximization vs imbalance penalty risk

This is a realistic merchant solar plant scenario based on how European electricity markets actually work.

## Development Commands

### Data Preparation

```bash
# Generate processed dataset from raw price/weather data
cd src/data_processing
python prepare_dataset.py
```

Creates `data/processed/{train.csv, test.csv, full_dataset.csv}` with:
- 20 MW solar plant production (scaled from weather data)
- Day-ahead prices (EUR/MWh)
- Simulated PV forecasts with realistic error
- Derived imbalance prices

### Training

```bash
cd src/training
python train.py  # Trains SAC agent, saves to models/
```

Training parameters:
- Algorithm: SAC (Soft Actor-Critic)
- 500k timesteps (~1.4 passes through 7 years)
- Checkpoints saved every 50k steps

### Evaluation

```bash
# Evaluate trained RL agent
python evaluate.py

# Compare rule-based baselines
python baseline_rules.py
```

### Monitor Training

```bash
# View training metrics in TensorBoard
tensorboard --logdir outputs/tensorboard
```

## Architecture

### Environment: `src/environment/solar_merchant_env.py`

**Core Decision Problem:**
- At 11:00 daily: commit how much energy to deliver each hour tomorrow
- Every hour: decide battery charge/discharge to meet commitments
- **Episodes are 48 hours** to ensure agent sees consequences of commitments (credit assignment fix)

**Action Space** (25-dimensional continuous):
- `action[0:24]`: Commitment fractions for each hour (0-1 of max possible)
- `action[24]`: Battery action (0=discharge, 0.5=idle, 1=charge)

**Observation Space** (84-dimensional):
- Current hour (1)
- Battery SOC (1)
- Today's commitment schedule (24)
- Cumulative imbalance today (1)
- PV forecast next 24h (24)
- Prices next 24h (24)
- Current actual PV (1)
- Weather features (2)
- Cyclical time features (6)

**Reward:**
```
reward = revenue - imbalance_cost - battery_degradation
```
Where:
- Revenue = delivered energy × day-ahead price
- Imbalance cost = penalty for over/under delivery
- Degradation = small cost per MWh battery throughput

### Plant Parameters

| Parameter | Value | Notes |
|-----------|-------|-------|
| Solar capacity | 20 MW | Peak output |
| Battery capacity | 10 MWh | Energy storage |
| Battery power | 5 MW | Max charge/discharge rate |
| Battery efficiency | 92% | Round-trip |
| Degradation cost | 0.01 EUR/MWh | Per throughput |

### Imbalance Settlement

Simplified model of real balancing market:
- **Short** (under-delivered): Pay 1.5× day-ahead price
- **Long** (over-delivered): Receive 0.6× day-ahead price

This creates asymmetric risk that the agent must learn to manage.

### Key Design Decisions & Constraints (V1)

**48-Hour Episodes:**
- Episodes span 48 hours to fix credit assignment problem
- Commitments made at hour 11 are for the next day (hours 13-36 of episode)
- Agent sees imbalance costs from those commitments before episode ends
- Previous 24h design was fundamentally broken - agent never learned from its commitments

**Commitment Tracking:**
- Separate `todays_commitments` and `tomorrows_commitments` arrays
- Prevents indexing bugs when episodes span midnight
- Tomorrow becomes today at midnight transition

**Battery Constraints:**
- Battery can ONLY charge from PV surplus, NOT from grid
- This eliminates price arbitrage strategies (buy low, sell high)
- Battery is purely for production smoothing and imbalance mitigation
- Future versions could add grid charging for arbitrage

**Action Space Inefficiency:**
- 24/25 action dimensions ignored 23/24 hours (only used at commitment hour)
- Acceptable for V1, could add action masking later to improve sample efficiency

## Data Pipeline

### Input Data (from Solar_Home_Assistant_V2)

| File | Content | Coverage |
|------|---------|----------|
| `data/prices/France_clean.csv` | Day-ahead wholesale prices | 2015-2025 |
| `data/weather/PV_production_2015_2023.csv` | Irradiance, temperature, wind | 2015-2023 |

### Processed Data

Generated by `prepare_dataset.py`:
- Scaled PV production (5 kW → 20 MW)
- Synthetic forecasts with 15% RMSE error
- Derived imbalance prices
- Time features (cyclical hour, day, month)

### Train/Test Split
- **Train**: 2015-2021 (7 years, ~61k hours)
- **Test**: 2022-2023 (2 years, ~17k hours)

## Key Design Decisions

### Why Day-Ahead Only (V1)

Simplified to single market to establish baseline. Future versions can add:
- Intraday market corrections
- Ancillary services
- Real-time balancing participation

### Forecast Error Model

Day-ahead solar forecasts have ~15-25% RMSE. We model this with:
- Temporally correlated noise (AR(1) process with ρ=0.8)
- Error proportional to production level
- Slight positive bias (optimistic forecasts)

### Why This Problem Should Favor RL

Unlike the residential battery problem with static prices:
- **Price volatility**: €0-300+/MWh creates arbitrage opportunities
- **Forecast uncertainty**: Must learn when to be conservative vs aggressive
- **Sequential decisions**: Commitments affect future flexibility
- **Asymmetric risk**: Short penalties > long opportunity cost

## Rule-Based Baselines

Three baseline policies for comparison:

1. **Conservative**: Commit 80% of forecast, use battery to fill gaps
2. **Aggressive**: Commit 100% + battery capacity, maximize revenue
3. **Price-Aware**: Adjust commitment based on price level

The RL agent should learn strategies that outperform all baselines.

## Future Directions (V2+)

1. **Intraday market**: Allow position adjustments as forecasts improve
2. **Multiple price scenarios**: Train on price forecast uncertainty
3. **Grid services**: Add frequency regulation revenue
4. **Multi-plant portfolio**: Optimize across multiple sites
